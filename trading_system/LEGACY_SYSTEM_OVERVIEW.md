
# Legacy Trading System Overview

這份文件整理目前交易系統的核心架構、已發生的實際問題、必須補齊的風控與保護機制，以及下一階段應實作的專業級模組設計藍圖，供其他 AI 或工程師快速理解並接手。

## 一、目前系統整體架構（Legacy 架構）

### 核心流程（交易生命週期）

1. 策略模組產生交易訊號（BUY / SELL + SL/TP 價位）
2. `OrderStateMachine.execute_trade_with_safety()` 負責：
   - 設定槓桿 / 保證金模式
   - 下進場單
   - 等待成交
   - 掛止損 / 止盈（保護單）
   - 驗證保護單是否存在
3. 若保護單失敗 ➜ 觸發 `EmergencyHandler` 緊急平倉 + 停止策略

### 主要模組（目前已有）

| 模組 | 功能 |
| --- | --- |
| `execution_safety.py` | 核心交易流程與安全機制 |
| `emergency_handler.py` | 保護失敗時的緊急平倉 |
| `BinanceFuturesClient` | REST API 客戶端 |
| 策略模組 | 產生 BUY / SELL 訊號與 SL/TP 價位 |

## 二、目前實際遇到的關鍵問題

### 1) 幣安 API 使用錯誤（致命）

`/fapi/v1/order` 對於 `STOP_MARKET` / `TAKE_PROFIT_MARKET` 在部分帳戶 / 模式 / 交易對會要求改用 Algo / Conditional Order API。嘗試 `/fapi/v1/order/conditional` 但實際環境不存在該路徑。

結果：SL / TP 永遠掛不上 → 每筆交易都被強制緊急平倉。

### 2) 保護單邏輯過度集中、脆弱

目前止損 / 止盈：

- 僅嘗試掛一次
- 無完整去重
- 無跨程序重啟後補單
- 無背景守護機制
- 任何失敗立即緊急平倉 + 停止策略

這在實盤會導致：系統幾乎無法穩定交易。

### 3) 缺乏真正的風控層（Risk Layer）

目前風控只在策略內決定 SL / TP，下單後才檢查保護單是否成功，缺少：

- 每筆交易風險金額控制（如：最多虧 1% 資金）
- 日虧損上限
- 連敗保護
- 最大槓桿限制
- 市況不利時的交易抑制

## 三、你真正想達到的目標（已確認）

目標報酬：週 5%～10%，且能長期穩定執行，不因單筆錯誤或 API 問題導致災難。未來支援牛熊切換，但先專注穩定系統。

意味著你需要的是：

- 不是更激進的策略
- 而是更穩定、可持續、風控嚴格、架構成熟的交易系統

## 四、專業級交易系統應有的核心模組（需補齊）

### 1) `RiskManager`（風險管理層）

職責：

- 根據帳戶資金與風險參數，決定每筆交易最大風險 %、最大可下單數量、最大槓桿
- 阻止不合理交易（過大倉位、風險失衡）

功能包含：

- 固定風險模型（每筆最多虧 1%）
- 連敗限制（連續 3 筆虧損暫停交易）
- 每日虧損上限
- 最大倉位比例限制
- 市況過度波動時風險調降

### 2) `ProtectionGuard`（保護單守衛層）

職責：確保任何時候所有倉位都有有效止損 / 止盈，且具備持續性保障。

必備能力：

- 保護單去重
- 程式重啟後自動補掛 SL/TP
- 保護單遺失偵測與補單
- 定期掃描所有倉位與掛單
- 驗證 SL / TP 是否存在、數量是否正確
- 失敗時：重試 ➜ 換 API 方案 ➜ 最後才緊急平倉

### 3) `MarketRegimeDetector`（市況識別層）

職責：判斷市場趨勢與波動型態，包含：

- 趨勢多頭 / 趨勢空頭 / 盤整 / 高波動
- 根據市況啟用 / 停用策略
- 調整風險參數，降低倉位或提高保護

### 4) `OrderStateMachine`（交易執行層）【需重構】

目前 `OrderStateMachine` 承擔過多責任（下單、掛保護單、驗證、失敗緊急處理）。

專業架構應改為：

- 僅負責流程控制
- 風控交給 `RiskManager`
- 保護交給 `ProtectionGuard`

## 五、Legacy 系統核心邏輯摘要（可直接交給其他 AI / 工程師）

目前交易系統採用單一 `OrderStateMachine` 控制整個交易流程，包含下單、等待成交、掛止損止盈與驗證。止損/止盈透過 Binance Futures REST API `/fapi/v1/order` 發送 `STOP_MARKET` 與 `TAKE_PROFIT_MARKET` 訂單，但實際環境回傳「Order type not supported」錯誤，導致保護單無法掛上。系統因此在每筆交易後觸發 `EmergencyHandler` 緊急平倉並停止策略，造成無法穩定交易。

系統目前缺乏獨立風控層（`RiskManager`）與持續保護層（`ProtectionGuard`）。止損止盈僅在下單後嘗試一次，無去重、無重啟補單、無背景監控。也未實作每筆交易最大風險控制、日虧損上限、連敗保護、市況調節等機制。

目標為建構專業級穩定交易架構，以實現長期可持續、風控嚴格、保護完整的交易系統，並支援未來牛熊切換。

## 六、接下來應該做什麼（不寫程式版本）

### 第一階段（現在）

- 不升級、不改架構
- 整理現況、封存 legacy 版本

### 第二階段（準備升級）

依序實作新模組：

1. `RiskManager`（風控層）
2. `ProtectionGuard`（保護層）
3. `MarketRegimeDetector`（市況層）
4. 重構 `OrderStateMachine` 對接上述模組

同時新增：

- 模擬測試流程
- 上線前檢查清單
- 異常回復機制

## 七、下一步我可以直接幫你做什麼

當你說一句：「開始升級 RiskManager + ProtectionGuard」，我會直接提供：

- 完整可執行的模組代碼
- 與你現有架構的對接方式
- 不破壞 legacy 的替換方案
- 測試流程與上線前驗證清單
